<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>CTS NMT Systems</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous" />
        <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
        <link rel="canonical" href="https://getbootstrap.com/docs/4.1/examples/sticky-footer/" />
        <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='semantic.css') }}" />
        <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='custom.css') }}" />
        
        <script src="https://code.jquery.com/jquery-3.3.1.js" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>
        <script src="{{ url_for('static', filename='semantic.js') }}"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.7.0/d3.min.js"></script>
        <script src="{{ url_for('static', filename='langid-model-full.js') }}"></script>
        <script src="{{ url_for('static', filename='langid.js') }}"></script>
        <script>
            $(document).on('click','#yesLang',function(){
                // $('input[class=sourcelang]').val(langs_dictionary[rank[i]["lang"]]).change();
                $("#lang0").html('');
                $("#lang0").hide();
                return false;
            });
            $(document).on('click','#noLang',function(){
                $('input[class=sourcelang]').val("").change();
                $("#lang0").html('Select a source language on your own, stop bothering me! I was just trying to help!');
                setTimeout(function() { 
                    $('#lang0').fadeOut();
                }, 2000);
                return false;
            });
            // $(document).ready(function(){
            //     $("#yesLang").click(function(){
            //         $('input[class=sourcelang]').val(langs_dictionary[rank[i]["lang"]]).change();
            //         $("#lang0").html('');
            //         $("#lang0").hide();
            //         return false;
            //     });
            // });
            $(document).ready(function(){
                $("#noLang").click(function(){
                    $('input[class=sourcelang]').val("").change();
                    $("#lang0").html('Select a source language on your own, stop bothering me!');
                    return false;
                });
            });
            // function yesLang(){
            //     $('input[class=sourcelang]').val(langs_dictionary[rank[i]["lang"]]).change();
            //     $("#lang0").html('');
            //     $("#lang0").hide();
            //     return false;
            // }
            // function noLang(){
            //     $('input[class=sourcelang]').val("").change();
            //     $("#lang0").html('Select a source language on your own, stop bothering me!');
            //     return false;
            // }
            $(document).ready(function() {
                langs_dictionary={ 
                    "af": "Afrikaans", 
                    "am": "Amharic", 
                    "ar": "Arabic", 
                    "az": "Azerbaijani", 
                    "be": "Belarusian", 
                    "bg": "Bulgarian", 
                    "bn": "Bengali", 
                    "br": "Breton", 
                    "bs": "Bosnian", 
                    "ca": "Valencian", 
                    "cs": "Czech", 
                    "cy": "Welsh", 
                    "da": "Danish", 
                    "de": "German", 
                    "el": "Greeek", 
                    "en": "English", 
                    "es": "Spanish", 
                    "et": "Estonian", 
                    "fa": "Persian", 
                    "fi": "Finnish", 
                    "fr": "French", 
                    "ga": "Irish", 
                    "gl": "Galician", 
                    "gu": "Gujarati", 
                    "he": "Hebrew", 
                    "hi": "Hindi", 
                    "hr": "Croatian", 
                    "ht": "Haitian Creole", 
                    "hu": "Hungarian", 
                    "hy": "Armenian", 
                    "id": "Indonesian", 
                    "is": "Icelandic", 
                    "it": "Italian", 
                    "ja": "Japanese", 
                    "jv": "Javanese", 
                    "ka": "Georgian", 
                    "kk": "Kazakh", 
                    "km": "Central Khmer", 
                    "kn": "Kannada", 
                    "ko": "Korean", 
                    "lb": "Letzeburgesch", 
                    "lo": "Lao", 
                    "lt": "Lithuanian", 
                    "lv": "Latvian", 
                    "mg": "Malagasy", 
                    "mk": "Macedonian", 
                    "ml": "Malayalam", 
                    "mn": "Mongolian", 
                    "mr": "Marathi", 
                    "ms": "Malay", 
                    "ne": "Nepali", 
                    "nl": "Flemish", 
                    "no": "Norwegian", 
                    "oc": "Occitan", 
                    "or": "Oriya", 
                    "pa": "Punjabi", 
                    "pl": "Polish", 
                    "ps": "Pashto", 
                    "pt": "Portuguese", 
                    "ro": "Moldovan", 
                    "ru": "Russian", 
                    "si": "Sinhalese", 
                    "sk": "Slovak", 
                    "sl": "Slovenian", 
                    "sq": "Albanian", 
                    "sr": "Serbian", 
                    "sv": "Swedish", 
                    "sw": "Swahili", 
                    "ta": "Tamil", 
                    "th": "Thai", 
                    "tl": "Tagalog", 
                    "tr": "Turkish", 
                    "uk": "Ukrainian", 
                    "ur": "Urdu", 
                    "vi": "Vietnamese", 
                    "xh": "Xhosa", 
                    "zh": "Chinese", 
                    "zu": "Zulu"
                };
                $("#textareasource").keyup(displayType);
            
                function displayType(){
                    var contents = $("#textareasource").val();
                        if (contents.length == 0) {
                            $("#detLangText").hide();
                            $("#lang0").hide();
                        }
                        else{
                            var rank = langid.rank(contents);
                            for (var i=0;i<1;i++){
                                $("#lang0").html("Source Language: " + langs_dictionary[rank[i]["lang"]] + "?  " + "<button id='yesLang' class='btn btn-sm btn-primary' type='button' >Yes</button>&nbsp;&nbsp;&nbsp;" + "<button id='noLang' class='btn btn-sm btn-danger' type='button' >No</button>");
                                $('input[class=sourcelang]').val(langs_dictionary[rank[i]["lang"]]).change();
                            }
                            if (contents != "The digital age, also referred to as the information society, is characterized by ever-growing volumes of information.")
                            {
                                $("#detLangText").show();
                                $("#lang0").show();
                            }
                        }
                    }
            });
            $(document).ready(function(){
                $('.ui.dropdown')
                .dropdown();
            });
            $(document).ready(function(){
                var textContent = "The digital age, also referred to as the information society, is characterized by ever-growing volumes of information.";
                $("#copybutton").click(function(){
                    $("#textareasource").val(textContent);
                    $('input[class=sourcelang]').val("English").change();
                });
            });
            $(document).ready(function(){
                $("#clearbutton").click(function(){
                    $("#textareasource").val('');
                });
            });
            function copy(selector){
                var $temp = $("<div>");
                $("body").append($temp);
                $temp.attr("contenteditable", true)
                    .html($(selector).html()).select()
                    .on("focus", function() { document.execCommand('selectAll',false,null); })
                    .focus();
                document.execCommand("copy");
                $temp.remove();
            }
            $(function(){
				$("#translate").click(function(){

                    $("#sourceAlert").hide()
                    $("#targetAlert").hide()
                    $("#rawTextAlert").hide()
                    $("#copyTransButton").hide()
                    $("#backTranslate").hide()
                    $("#attinfo").html("");
                    $("#attinfo").hide();

                    if($('input[class=sourcelang]').val() == ""){
                        $("#sourceAlert").show()
                        return false;
                    }
                    if($('input[class=targetlang]').val() == ""){
                        $("#targetAlert").show()
                        return false;
                    }
                    if($("#textareasource").val() == ""){
                        $("#rawTextAlert").show()
                        return false;
                    }
                    var requestData = {
                        "sourcelang": $('input[class=sourcelang]').val(),
                        "targetlang": $('input[class=targetlang]').val(),
                        "rawtext": $("#textareasource").val()
                    }
                    // console.log(requestData);
                    $("#originalText").html(requestData['rawtext']);
                    $("#translatedText").html("Translating...");
                    $.ajax({
                        url: "{{ url_for('request_api.translate') }}",
                        type: "POST",
                        data: requestData,
                        success: function(data){
                            $("#translatedText").html(data.translated_text);
                            $("#copyTransButton").show()
                            $("#backTranslate").show()
                            $("#visualizeButton").show()
                        }
                    });
				});
			});
            $(function(){
				$("#backTranslate").click(function(){
                    // alert($("#translatedText").html());
                    $("#sourceAlert").hide()
                    $("#targetAlert").hide()
                    $("#rawTextAlert").hide()
                    $("#copyTransButton").hide()
                    $("#backTranslate").hide()
                    $("#attText").hide();
                    $("#attinfo").html("");
                    $("#attinfo").hide();
                    var textContent = $("#translatedText").html();
                    $("#textareasource").val(textContent);
                    var sourceLangNew = $('input[class=targetlang]').val();
                    var targetLangNew = $('input[class=sourcelang]').val();
                    // alert(sourceLangNew);
                    // alert(targetLangNew);
                    $("#sourcelang").val(sourceLangNew).change();
                    $("#targetlang").val(targetLangNew).change();
                    
                    var requestData = {
                        "sourcelang": $('input[class=sourcelang]').val(),
                        "targetlang": $('input[class=targetlang]').val(),
                        "rawtext": $("#textareasource").val()
                    }
                    // console.log(requestData);
                    $("#originalText").html(requestData['rawtext']);
                    $("#translatedText").html("Translating...");
                    $.ajax({
                        url: "{{ url_for('request_api.translate') }}",
                        type: "POST",
                        data: requestData,
                        success: function(data){
                            $("#translatedText").html(data.translated_text);
                            $("#copyTransButton").show()
                            $("#backTranslate").show()
                            $("#visualizeButton").show()
                        }
                    });
				});
			});
            $(function(){
				$("#visualizeButton").click(function(){

                    var requestData = {
                        "sourcelang": $('input[class=sourcelang]').val(),
                        "targetlang": $('input[class=targetlang]').val(),
                        "rawtext": $("#originalText").html()
                    }
                    $("#attText").show();
                    $("#attinfo").show();
                    $("#attinfo").html("Visualizing...");
                    $.ajax({
                        url: "{{ url_for('request_api.visualize') }}",
                        type: "POST",
                        data: requestData,
                        success: function(data){
                            $("#attinfo").html(data.vishtml);
                            renderattentions(data.pyparams);
                        }
                    });
				});
			});
            function renderattentions(PYTHON_PARAMS){
                const params = PYTHON_PARAMS; // HACK: PYTHON_PARAMS is a template marker that is replaced by actual params.
                const config = {};

                const MIN_X = 0;
                const MIN_Y = 0;
                const DIV_WIDTH = 970;
                const THUMBNAIL_PADDING = 5;
                const DETAIL_WIDTH = 300;
                const DETAIL_ATTENTION_WIDTH = 140;
                const DETAIL_BOX_WIDTH = 80;
                const DETAIL_BOX_HEIGHT = 18;
                const DETAIL_PADDING = 15;
                const ATTN_PADDING = 0;
                const DETAIL_HEADING_HEIGHT = 25;
                const HEADING_TEXT_SIZE = 15;
                const HEADING_PADDING = 5;
                const TEXT_SIZE = 13;
                const TEXT_PADDING = 5;
                const LAYER_COLORS = d3.schemeCategory10;
                const PALETTE = {
                    'light': {
                        'text': 'black',
                        'background': 'white',
                        'highlight': '#F5F5F5'
                    },
                    'dark': {
                        'text': '#ccc',
                        'background': 'black',
                        'highlight': '#222'
                    }
                }

                function render() {

                    // Set global state variables
                    
                    var attData = config.attention[config.filter];
                    config.leftText = attData.left_text;
                    config.rightText = attData.right_text;
                    config.attn = attData.attn;
                    config.numLayers = config.attn.length;
                    config.numHeads = config.attn[0].length;
                    config.thumbnailBoxHeight = 7 * (12 / config.totalHeads);
                    const axisSize = HEADING_TEXT_SIZE + HEADING_PADDING + TEXT_SIZE + TEXT_PADDING;
                    config.thumbnailHeight = Math.max(config.leftText.length, config.rightText.length) * config.thumbnailBoxHeight + 2 * THUMBNAIL_PADDING;
                    config.thumbnailWidth = (DIV_WIDTH - axisSize) / config.totalHeads;
                    config.detailHeight = Math.max(config.leftText.length, config.rightText.length) * DETAIL_BOX_HEIGHT + 2 * DETAIL_PADDING + DETAIL_HEADING_HEIGHT;
                    config.divHeight = Math.max(config.numLayers * config.thumbnailHeight + axisSize, config.detailHeight);

                    const vis = $(`#${config.rootDivId} #vis`)
                    vis.empty();
                    vis.attr("height", config.divHeight);
                    config.svg = d3.select(`#${config.rootDivId} #vis`)
                        .append('svg')
                        .attr("width", DIV_WIDTH)
                        .attr("height", config.divHeight)
                        .attr("fill", getBackgroundColor());

                    renderAxisLabels();

                    var i;
                    var j;
                    for (i = 0; i < config.numLayers; i++) {
                        for (j = 0; j < config.numHeads; j++) {
                            renderThumbnail(i, j);
                        }
                    }
                    // vis.show();
                }

                function renderAxisLabels() {
                    const axisSize = HEADING_TEXT_SIZE + HEADING_PADDING + TEXT_SIZE + TEXT_PADDING;
                    const tableWidth = config.thumbnailWidth * config.heads.length;
                    config.svg.append("text")
                        .text("Heads")
                        .attr("fill", "black")
                        .attr("font-weight", "bold")
                        .attr("font-size", HEADING_TEXT_SIZE + "px")
                        .attr("x", axisSize + tableWidth / 2)
                        .attr("text-anchor", "middle")
                        .attr("y", 0)
                        .attr("dy", HEADING_TEXT_SIZE);
                    for (let i = 0; i < config.numHeads; i++) {
                        config.svg.append("text")
                            .text(config.heads[i])
                            .attr("fill", "black")
                            .attr("font-size", TEXT_SIZE + "px")
                            .attr("x", axisSize + (i + .5) * config.thumbnailWidth)
                            .attr("text-anchor", "middle")
                            .attr("y", HEADING_TEXT_SIZE + HEADING_PADDING)
                            .attr("dy", TEXT_SIZE);
                    }
                    let x = 0;
                    let y = axisSize + config.thumbnailHeight * config.layers.length / 2;
                    console.log("x", x, y)
                    config.svg.append("text")
                        .text("Layers")
                        .attr("fill", "black")
                        .attr("font-weight", "bold")
                        .attr("transform", "rotate(270, " + x  + ", " + y + ")")
                        .attr("font-size", HEADING_TEXT_SIZE + "px")
                        .attr("x", x)
                        .attr("text-anchor", "middle")
                        .attr("y", y)
                        .attr("dy", HEADING_TEXT_SIZE);
                    for (let i = 0; i < config.numLayers; i++) {
                        x = HEADING_TEXT_SIZE + HEADING_PADDING + TEXT_SIZE; // HACK
                        y = axisSize + (i + .5) * config.thumbnailHeight;
                        config.svg.append("text")
                            .text(config.layers[i])
                            .attr("fill", "black")
                            .attr("font-size", TEXT_SIZE + "px")
                            .attr("x", x)
                            .attr("text-anchor", "end")
                            .attr("y", y)
                            .attr("dy", TEXT_SIZE / 2);
                    }
                }


                function renderThumbnail(layerIndex, headIndex) {
                    const axisSize = HEADING_TEXT_SIZE + HEADING_PADDING + TEXT_SIZE + TEXT_PADDING
                    const x = headIndex * config.thumbnailWidth + axisSize;
                    const y = layerIndex * config.thumbnailHeight + axisSize;
                    renderThumbnailAttn(x, y, config.attn[layerIndex][headIndex], layerIndex, headIndex);
                }

                function renderDetail(att, layerIndex, headIndex) {
                    const axisSize = TEXT_SIZE + HEADING_PADDING + TEXT_SIZE + TEXT_PADDING;
                    var xOffset = .8 * config.thumbnailWidth;
                    var maxX = DIV_WIDTH;
                    var maxY = config.divHeight - 3;
                    var leftPos = axisSize + headIndex * config.thumbnailWidth;
                    var x = leftPos + THUMBNAIL_PADDING + xOffset;
                    if (x < MIN_X) {
                        x = MIN_X;
                    } else if (x + DETAIL_WIDTH > maxX) {
                        x = leftPos + THUMBNAIL_PADDING - DETAIL_WIDTH + 8;
                    }
                    var posLeftText = x;
                    var posAttention = posLeftText + DETAIL_BOX_WIDTH;
                    var posRightText = posAttention + DETAIL_ATTENTION_WIDTH;
                    var thumbnailHeight = Math.max(config.leftText.length, config.rightText.length) * config.thumbnailBoxHeight + 2 * THUMBNAIL_PADDING;
                    var yOffset = 20;
                    var y = layerIndex * thumbnailHeight + THUMBNAIL_PADDING + yOffset;
                    if (y < MIN_Y) {
                        y = MIN_Y;
                    } else if (y + config.detailHeight > maxY) {
                        y = maxY - config.detailHeight;
                    }
                    renderDetailFrame(x, y, layerIndex);
                    y = y + DETAIL_PADDING;
                    renderDetailHeading(x, y, layerIndex, headIndex);
                    y = y + DETAIL_HEADING_HEIGHT;
                    renderDetailText(config.leftText, "leftText", posLeftText, y , layerIndex);
                    renderDetailAttn(posAttention, y, att, layerIndex, headIndex);
                    renderDetailText(config.rightText, "rightText", posRightText, y, layerIndex);
                }

                function renderDetailHeading(x, y, layerIndex, headIndex) {
                    var fillColor = getTextColor();
                    config.svg.append("text")
                        .classed("detail", true)
                        .text('Layer ' + config.layers[layerIndex] + ", Head " + config.heads[headIndex])
                        .attr("font-size", TEXT_SIZE + "px")
                        .attr("font-weight", "bold")
                        .style("cursor", "default")
                        .style("-webkit-user-select", "none")
                        .attr("fill", fillColor)
                        .attr("x", x + DETAIL_WIDTH / 2)
                        .attr("text-anchor", "middle")
                        .attr("y", y)
                        .attr("height", DETAIL_HEADING_HEIGHT)
                        .attr("width", DETAIL_WIDTH)
                        .attr("dy", HEADING_TEXT_SIZE);
                }

                function renderDetailText(text, id, x, y, layerIndex) {
                    var tokenContainer = config.svg.append("svg:g")
                        .classed("detail", true)
                        .selectAll("g")
                        .data(text)
                        .enter()
                        .append("g");

                    var fillColor = getTextColor();

                    tokenContainer.append("rect")
                        .classed("highlight", true)
                        .attr("fill", fillColor)
                        .style("opacity", 0.0)
                        .attr("height", DETAIL_BOX_HEIGHT)
                        .attr("width", DETAIL_BOX_WIDTH)
                        .attr("x", x)
                        .attr("y", function (d, i) {
                            return y + i * DETAIL_BOX_HEIGHT;
                        });

                    var textContainer = tokenContainer.append("text")
                        .classed("token", true)
                        .text(function (d) {
                            return d;
                        })
                        .attr("font-size", TEXT_SIZE + "px")
                        .style("cursor", "default")
                        .style("-webkit-user-select", "none")
                        .attr("fill", fillColor)
                        .attr("x", x)
                        .attr("y", function (d, i) {
                            return i * DETAIL_BOX_HEIGHT + y;
                        })
                        .attr("height", DETAIL_BOX_HEIGHT)
                        .attr("width", DETAIL_BOX_WIDTH)
                        .attr("dy", TEXT_SIZE);

                    if (id == "leftText") {
                        textContainer.style("text-anchor", "end")
                            .attr("dx", DETAIL_BOX_WIDTH - 2);
                        tokenContainer.on("mouseover", function (d, index) {
                            highlightSelection(index);
                        });
                        tokenContainer.on("mouseleave", function () {
                            unhighlightSelection();
                        });
                    }
                }

                function highlightSelection(index) {
                    config.svg.select("#leftText")
                        .selectAll(".highlight")
                        .style("opacity", function (d, i) {
                            return i == index ? 1.0 : 0.0;
                        });
                    config.svg.selectAll(".attn-line-group")
                        .style("opacity", function (d, i) {
                            return i == index ? 1.0 : 0.0;
                        });
                }

                function unhighlightSelection() {
                    config.svg.select("#leftText")
                        .selectAll(".highlight")
                        .style("opacity", 0.0);
                    config.svg.selectAll(".attn-line-group")
                        .style("opacity", 1);
                }

                function renderThumbnailAttn(x, y, att, layerIndex, headIndex) {

                    var attnContainer = config.svg.append("svg:g");

                    var attnBackground = attnContainer.append("rect")
                        .attr("id", 'attn_background_' + layerIndex + "_" + headIndex)
                        .classed("attn_background", true)
                        .attr("x", x)
                        .attr("y", y)
                        .attr("height", config.thumbnailHeight)
                        .attr("width", config.thumbnailWidth)
                        .attr("stroke-width", 2)
                        .attr("stroke", getLayerColor(layerIndex))
                        .attr("stroke-opacity", 0)
                        .attr("fill", getBackgroundColor());
                    var x1 = x + THUMBNAIL_PADDING;
                    var x2 = x1 + config.thumbnailWidth - 14;
                    var y1 = y + THUMBNAIL_PADDING;

                    attnContainer.selectAll("g")
                        .data(att)
                        .enter()
                        .append("g") // Add group for each source token
                        .attr("source-index", function (d, i) { // Save index of source token
                            return i;
                        })
                        .selectAll("line")
                        .data(function (d) { // Loop over all target tokens
                            return d;
                        })
                        .enter() // When entering
                        .append("line")
                        .attr("x1", x1)
                        .attr("y1", function (d) {
                            var sourceIndex = +this.parentNode.getAttribute("source-index");
                            return y1 + (sourceIndex + .5) * config.thumbnailBoxHeight;
                        })
                        .attr("x2", x2)
                        .attr("y2", function (d, targetIndex) {
                            return y1 + (targetIndex + .5) * config.thumbnailBoxHeight;
                        })
                        .attr("stroke-width", 2.2)
                        .attr("stroke", getLayerColor(layerIndex))
                        .attr("stroke-opacity", function (d) {
                            return d;
                        });

                    var clickRegion = attnContainer.append("rect")
                        .attr("x", x)
                        .attr("y", y)
                        .attr("height", config.thumbnailHeight)
                        .attr("width", config.thumbnailWidth)
                        .style("opacity", 0);

                    clickRegion.on("click", function (d, index) {
                        var attnBackgroundOther = config.svg.selectAll(".attn_background");
                        attnBackgroundOther.attr("fill", getBackgroundColor());
                        attnBackgroundOther.attr("stroke-opacity", 0);

                        config.svg.selectAll(".detail").remove();
                        if (config.detail_layer != layerIndex || config.detail_head != headIndex) {
                            renderDetail(att, layerIndex, headIndex);
                            config.detail_layer = layerIndex;
                            config.detail_head = headIndex;
                            attnBackground.attr("fill", getHighlightColor());
                            attnBackground.attr("stroke-opacity", .8);
                        } else {
                            config.detail_layer = null;
                            config.detail_head = null;
                            attnBackground.attr("fill", getBackgroundColor());
                            attnBackground.attr("stroke-opacity", 0);
                        }
                    });

                    clickRegion.on("mouseover", function (d) {
                        d3.select(this).style("cursor", "pointer");
                    });
                }

                function renderDetailFrame(x, y, layerIndex) {
                    var detailFrame = config.svg.append("rect")
                        .classed("detail", true)
                        .attr("x", x)
                        .attr("y", y)
                        .attr("height", config.detailHeight)
                        .attr("width", DETAIL_WIDTH)
                        .style("opacity", 1)
                        .attr("stroke-width", 1.5)
                        .attr("stroke-opacity", 0.7)
                        .attr("stroke", getLayerColor(layerIndex));
                }

                function renderDetailAttn(x, y, att, layerIndex) {
                    var attnContainer = config.svg.append("svg:g")
                        .classed("detail", true)
                        .attr("pointer-events", "none");
                    attnContainer.selectAll("g")
                        .data(att)
                        .enter()
                        .append("g") // Add group for each source token
                        .classed('attn-line-group', true)
                        .attr("source-index", function (d, i) { // Save index of source token
                            return i;
                        })
                        .selectAll("line")
                        .data(function (d) { // Loop over all target tokens
                            return d;
                        })
                        .enter()
                        .append("line")
                        .attr("x1", x + ATTN_PADDING)
                        .attr("y1", function (d) {
                            var sourceIndex = +this.parentNode.getAttribute("source-index");
                            return y + (sourceIndex + .5) * DETAIL_BOX_HEIGHT;
                        })
                        .attr("x2", x + DETAIL_ATTENTION_WIDTH - ATTN_PADDING)
                        .attr("y2", function (d, targetIndex) {
                            return y + (targetIndex + .5) * DETAIL_BOX_HEIGHT;
                        })
                        .attr("stroke-width", 2.2)
                        .attr("stroke", getLayerColor(layerIndex))
                        .attr("stroke-opacity", function (d) {
                            return d;
                        });
                }

                function getLayerColor(layer) {
                    return LAYER_COLORS[config.layers[layer] % 10];
                }

                function getTextColor() {
                    return PALETTE[config.mode]['text']
                }

                function getBackgroundColor() {
                    return PALETTE[config.mode]['background']
                }

                function getHighlightColor() {
                    return PALETTE[config.mode]['highlight']
                }

                function initialize() {
                    // alert(params["attention"]);
                    config.attention = params['attention'];
                    config.filter = params['default_filter'];
                    config.mode = params['display_mode'];
                    config.layers = params['include_layers']
                    config.heads = params['include_heads']
                    config.totalHeads = params['total_heads']
                    config.rootDivId = params['root_div_id'];
                    $(`#${config.rootDivId} #filter`).on('change', function (e) {
                        // $(`#${config.rootDivId} #vis`).html('<p>Loading...</p>');
                        config.filter = e.currentTarget.value;
                        render();
                    });
                }
                initialize();
                render();
            }
        </script>
        
    </head>
    <body>
        <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
            <a class="navbar-brand" href="/"><font size="+1"><img src="{{ url_for('static', filename='favicon.png') }}" height="40px"/>&nbsp;&nbsp;&nbsp;&nbsp;Centre for Translation Studies :: Neural Machine Translation Web Application</a>

            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
        </nav>
        <br /><br /><br /><br />
        <div class="container">
            <form method="POST">
				<p id="textsample">A sample sentence: The digital age, also referred to as the information society, is characterized by ever-growing volumes of information.</p>
                <button id ="copybutton" type="button" class="btn btn-sm btn-info" ><i class="fa fa-clone"></i> Copy to Text Area</button> <button id ="clearbutton" type="button" class="btn btn-sm btn-info" ><i class="fa fa-trash"></i> Clear Text Area</button>
                <br /><br />
                <div class="container ui stackable equal width grid">
                    <div class="ui fluid alert alert-warning column" style="display: none" id="sourceAlert"> 
                        <a class="close" onclick="$('#sourceAlert').hide()">×</a>  
                        Please specify the <strong>Source Language</strong>.  
                    </div>
                    <div class="ui fluid alert alert-warning column" style="display: none" id="targetAlert"> 
                        <a class="close" onclick="$('#targetAlert').hide()">×</a>  
                        Please specify the <strong>Target Language</strong>.  
                    </div>
                    <div class="ui fluid alert alert-warning column" style="display: none" id="rawTextAlert"> 
                        <a class="close" onclick="$('#rawTextAlert').hide()">×</a>  
                        Please enter <strong>the text</strong> to be translated.
                    </div>
                </div>
                <hr><br/>
                <div class="form-group">    
                    
                    <div class="container ui stackable equal width grid">
                        <div class="ui fluid search dropdown button column">
                            <i class="cloud icon"></i>
                            <span class="text">Model-Domain</span>
                            <div class="menu">
                                <div class="item disabled">Facebook M2M</div>
                            </div>
                        </div>
                        <div class="ui fluid search dropdown button column">
                            <input type="hidden" id="sourcelang" name="sourcelang" class="sourcelang">
                            <span class="text"><i class="world icon"></i>Source Language</span>
                            <div class="menu" id="sourcel">
                                <div class="item" data-id="af">Afrikaans</div><div class="item" data-id="sq">Albanian</div><div class="item" data-id="am">Amharic</div><div class="item" data-id="ar">Arabic</div><div class="item" data-id="hy">Armenian</div><div class="item" data-id="ast">Asturian</div><div class="item" data-id="az">Azerbaijani</div><div class="item" data-id="ba">Bashkir</div><div class="item" data-id="be">Belarusian</div><div class="item" data-id="bg">Bulgarian</div><div class="item" data-id="bn">Bengali</div><div class="item" data-id="br">Breton</div><div class="item" data-id="bs">Bosnian</div><div class="item" data-id="ceb">Cebuano</div><div class="item" data-id="zh">Chinese</div><div class="item" data-id="cs">Czech</div><div class="item" data-id="da">Danish</div><div class="item" data-id="en">English</div><div class="item" data-id="et">Estonian</div><div class="item" data-id="fi">Finnish</div><div class="item" data-id="nl">Flemish</div><div class="item" data-id="fr">French</div><div class="item" data-id="ff">Fulah</div><div class="item" data-id="de">German</div><div class="item" data-id="el">Greeek</div><div class="item" data-id="fa">Persian</div><div class="item" data-id="ga">Irish</div><div class="item" data-id="gd">Scottish Gaelic</div><div class="item" data-id="gl">Galician</div><div class="item" data-id="lg">Ganda</div><div class="item" data-id="gu">Gujarati</div><div class="item" data-id="ha">Hausa</div><div class="item" data-id="he">Hebrew</div><div class="item" data-id="hi">Hindi</div><div class="item" data-id="hr">Croatian</div><div class="item" data-id="ht">Haitian Creole</div><div class="item" data-id="hu">Hungarian</div><div class="item" data-id="id">Indonesian</div><div class="item" data-id="ig">Igbo</div><div class="item" data-id="ilo">Iloko</div><div class="item" data-id="is">Icelandic</div><div class="item" data-id="it">Italian</div><div class="item" data-id="ja">Japanese</div><div class="item" data-id="jv">Javanese</div><div class="item" data-id="ka">Georgian</div><div class="item" data-id="kk">Kazakh</div><div class="item" data-id="km">Central Khmer</div><div class="item" data-id="kn">Kannada</div><div class="item" data-id="ko">Korean</div><div class="item" data-id="lb">Letzeburgesch</div><div class="item" data-id="ln">Lingala</div><div class="item" data-id="lo">Lao</div><div class="item" data-id="lt">Lithuanian</div><div class="item" data-id="lv">Latvian</div><div class="item" data-id="mk">Macedonian</div><div class="item" data-id="mg">Malagasy</div><div class="item" data-id="ml">Malayalam</div><div class="item" data-id="mr">Marathi</div><div class="item" data-id="mn">Mongolian</div><div class="item" data-id="ro">Moldovan</div><div class="item" data-id="ms">Malay</div><div class="item" data-id="my">Burmese</div><div class="item" data-id="ne">Nepali</div><div class="item" data-id="no">Norwegian</div><div class="item" data-id="ns">Northern Sotho</div><div class="item" data-id="oc">Occitan</div><div class="item" data-id="or">Oriya</div><div class="item" data-id="pa">Punjabi</div><div class="item" data-id="pl">Polish</div><div class="item" data-id="ps">Pashto</div><div class="item" data-id="pt">Portuguese</div><div class="item" data-id="ru">Russian</div><div class="item" data-id="sr">Serbian</div><div class="item" data-id="sd">Sindhi</div><div class="item" data-id="si">Sinhalese</div><div class="item" data-id="sk">Slovak</div><div class="item" data-id="sl">Slovenian</div><div class="item" data-id="so">Somali</div><div class="item" data-id="es">Spanish</div><div class="item" data-id="ss">Swati</div><div class="item" data-id="su">Sundanese</div><div class="item" data-id="sv">Swedish</div><div class="item" data-id="sw">Swahili</div><div class="item" data-id="ta">Tamil</div><div class="item" data-id="th">Thai</div><div class="item" data-id="tl">Tagalog</div><div class="item" data-id="tn">Tswana</div><div class="item" data-id="tr">Turkish</div><div class="item" data-id="uk">Ukrainian</div><div class="item" data-id="ur">Urdu</div><div class="item" data-id="uz">Uzbek</div><div class="item" data-id="ca">Valencian</div><div class="item" data-id="vi">Vietnamese</div><div class="item" data-id="cy">Welsh</div><div class="item" data-id="wo">Wolof</div><div class="item" data-id="xh">Xhosa</div><div class="item" data-id="yi">Yiddish</div><div class="item" data-id="yo">Yoruba</div><div class="item" data-id="zu">Zulu</div>
                            </div>
                        </div>
                        <div class="ui fluid search dropdown button column">
                            <input type="hidden" id="targetlang" name="targetlang" class="targetlang">
                            <span class="text"><i class="world icon"></i>Target Language</span>
                            <div class="menu" id="targetl">
                                <div class="item" data-id="af">Afrikaans</div><div class="item" data-id="sq">Albanian</div><div class="item" data-id="am">Amharic</div><div class="item" data-id="ar">Arabic</div><div class="item" data-id="hy">Armenian</div><div class="item" data-id="ast">Asturian</div><div class="item" data-id="az">Azerbaijani</div><div class="item" data-id="ba">Bashkir</div><div class="item" data-id="be">Belarusian</div><div class="item" data-id="bg">Bulgarian</div><div class="item" data-id="bn">Bengali</div><div class="item" data-id="br">Breton</div><div class="item" data-id="bs">Bosnian</div><div class="item" data-id="ceb">Cebuano</div><div class="item" data-id="zh">Chinese</div><div class="item" data-id="cs">Czech</div><div class="item" data-id="da">Danish</div><div class="item" data-id="en">English</div><div class="item" data-id="et">Estonian</div><div class="item" data-id="fi">Finnish</div><div class="item" data-id="nl">Flemish</div><div class="item" data-id="fr">French</div><div class="item" data-id="ff">Fulah</div><div class="item" data-id="de">German</div><div class="item" data-id="el">Greeek</div><div class="item" data-id="fa">Persian</div><div class="item" data-id="ga">Irish</div><div class="item" data-id="gd">Scottish Gaelic</div><div class="item" data-id="gl">Galician</div><div class="item" data-id="lg">Ganda</div><div class="item" data-id="gu">Gujarati</div><div class="item" data-id="ha">Hausa</div><div class="item" data-id="he">Hebrew</div><div class="item" data-id="hi">Hindi</div><div class="item" data-id="hr">Croatian</div><div class="item" data-id="ht">Haitian Creole</div><div class="item" data-id="hu">Hungarian</div><div class="item" data-id="id">Indonesian</div><div class="item" data-id="ig">Igbo</div><div class="item" data-id="ilo">Iloko</div><div class="item" data-id="is">Icelandic</div><div class="item" data-id="it">Italian</div><div class="item" data-id="ja">Japanese</div><div class="item" data-id="jv">Javanese</div><div class="item" data-id="ka">Georgian</div><div class="item" data-id="kk">Kazakh</div><div class="item" data-id="km">Central Khmer</div><div class="item" data-id="kn">Kannada</div><div class="item" data-id="ko">Korean</div><div class="item" data-id="lb">Letzeburgesch</div><div class="item" data-id="ln">Lingala</div><div class="item" data-id="lo">Lao</div><div class="item" data-id="lt">Lithuanian</div><div class="item" data-id="lv">Latvian</div><div class="item" data-id="mk">Macedonian</div><div class="item" data-id="mg">Malagasy</div><div class="item" data-id="ml">Malayalam</div><div class="item" data-id="mr">Marathi</div><div class="item" data-id="mn">Mongolian</div><div class="item" data-id="ro">Moldovan</div><div class="item" data-id="ms">Malay</div><div class="item" data-id="my">Burmese</div><div class="item" data-id="ne">Nepali</div><div class="item" data-id="no">Norwegian</div><div class="item" data-id="ns">Northern Sotho</div><div class="item" data-id="oc">Occitan</div><div class="item" data-id="or">Oriya</div><div class="item" data-id="pa">Punjabi</div><div class="item" data-id="pl">Polish</div><div class="item" data-id="ps">Pashto</div><div class="item" data-id="pt">Portuguese</div><div class="item" data-id="ru">Russian</div><div class="item" data-id="sr">Serbian</div><div class="item" data-id="sd">Sindhi</div><div class="item" data-id="si">Sinhalese</div><div class="item" data-id="sk">Slovak</div><div class="item" data-id="sl">Slovenian</div><div class="item" data-id="so">Somali</div><div class="item" data-id="es">Spanish</div><div class="item" data-id="ss">Swati</div><div class="item" data-id="su">Sundanese</div><div class="item" data-id="sv">Swedish</div><div class="item" data-id="sw">Swahili</div><div class="item" data-id="ta">Tamil</div><div class="item" data-id="th">Thai</div><div class="item" data-id="tl">Tagalog</div><div class="item" data-id="tn">Tswana</div><div class="item" data-id="tr">Turkish</div><div class="item" data-id="uk">Ukrainian</div><div class="item" data-id="ur">Urdu</div><div class="item" data-id="uz">Uzbek</div><div class="item" data-id="ca">Valencian</div><div class="item" data-id="vi">Vietnamese</div><div class="item" data-id="cy">Welsh</div><div class="item" data-id="wo">Wolof</div><div class="item" data-id="xh">Xhosa</div><div class="item" data-id="yi">Yiddish</div><div class="item" data-id="yo">Yoruba</div><div class="item" data-id="zu">Zulu</div>
                            </div>
                        </div>
                      </div>
					<br />
                    <p id="lang0" style="display: none"></p>
                    <hr/>
                    <br />
                    <textarea rows="5" cols="5" class="form-control" id="textareasource" placeholder="Enter text (preferably one sentence)" name="rawtext" required>{{ source_text }}</textarea>
                    <br />
                    <button id ="translate" type="button" class="btn btn-lg btn-info" ><i class="fa fa-database"></i> Translate</button>
                </div>
            </form>
        </div>

        <div class="container ui stackable equal width grid">
            <div class="column">
                <p>Original</p>
                <div id="originalText" class="alert alert-success" role="alert">
                </div>
            </div>
            <div class="column">
                <p>Translation</p>
                <div id="translatedText" class="alert alert-success" role="alert">
                </div>
                <button class="btn btn-sm btn-info" id="copyTransButton" style="display: none" onclick="copy('#translatedText')"><i class="fa fa-clipboard"></i> Copy Translation to Clipboard</button> 
                <button class="btn btn-sm btn-info" id="backTranslate" style="display: none" ><i class="fa fa-repeat"></i> Back-translate</button> 
                <button class="btn btn-sm btn-info" id="visualizeButton" style="display: none"><i class="fa fa-line-chart"></i> Visualize Attention</button>
            </div>
          </div>
        </div>
        <div class="container ui stackable equal width grid">
            <div class="column">
                 
                <p id="attText" style="display: none">Attention Visualization</p>
                <div id="attinfo" class="alert alert-success" role="alert" style="display: none">
                    
                </div>
                    
                </div>
            </div>


        <!-- Footer -->
        <footer class="footer">
          <div class="container">
            <span class="text-muted">
                V. 0.2 - Being developed by <a href='https://dipteshkanojia.github.io'>Diptesh</a>; <a href="https://github.com/fantinuoli/Local-NMT">Original template</a>; Translation model at <a href="https://huggingface.co/docs/transformers/model_doc/m2m_100">HuggingFace FB-M2M Model</a>.
            </span>
          </div>
        </footer>
    </body>
</html>